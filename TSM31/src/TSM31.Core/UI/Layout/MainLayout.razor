@using Microsoft.FluentUI.AspNetCore.Components.Extensions
@using Microsoft.FluentUI.AspNetCore.Components.Icons.Filled
@inherits LayoutComponentBase
<FluentLayout>
    <FluentHeader>
        TSM31
        <FluentSpacer />

        <FluentDesignTheme @bind-Mode="@Mode" @bind-OfficeColor="@OfficeColor" OnLoaded="@OnLoaded"
            OnLuminanceChanged="@OnLuminanceChanged" StorageName="theme" />

        <FluentButton Id="theme-menu-button" Appearance="Appearance.Stealth" OnClick="ToggleThemeMenu"
            AriaExpanded="@IsThemeMenuOpen">
            Theme options
        </FluentButton>

        <FluentPopover AnchorId="theme-menu-button" Style="width: 320px;" @bind-Open="IsThemeMenuOpen">
            <Header>
                <FluentLabel Typo="Typography.Header">Theme Options</FluentLabel>
            </Header>

            <Body>
                <FluentGrid>
                    <FluentGridItem>
                        <FluentSelect Label="Theme" Width="250px" Items="@(Enum.GetValues<DesignThemeModes>())"
                            @bind-SelectedOption="@Mode" />
                    </FluentGridItem>

                    <FluentGridItem>
                        <FluentSelect Label="Color"
                            Items="@(Enum.GetValues<OfficeColor>().Select(i => (OfficeColor?)i))" Height="200px"
                            Width="250px" @bind-SelectedOption="@OfficeColor">
                            <OptionTemplate>
                                <FluentStack>
                                    <FluentIcon Value="@(new Size20.RectangleLandscape())"
                                        Color="Color.Custom" CustomColor="@GetCustomColor(context)" />
                                    <FluentLabel>@context</FluentLabel>
                                </FluentStack>
                            </OptionTemplate>
                        </FluentSelect>
                        <FluentButton Appearance="Appearance.Accent" OnClick="PickRandomColor">
                            Feeling lucky?
                        </FluentButton>
                    </FluentGridItem>
                </FluentGrid>
            </Body>
        </FluentPopover>

    </FluentHeader>
    <FluentStack Class="main" Orientation="Orientation.Horizontal" Width="100%">
        <NavMenu />
        <FluentBodyContent Class="body-content">
            <div class="content">
                @Body
            </div>
        </FluentBodyContent>
    </FluentStack>
</FluentLayout>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code
{
    public DesignThemeModes Mode { get; set; } = DesignThemeModes.System;

    public OfficeColor? OfficeColor { get; set; }

    bool IsThemeMenuOpen { get; set; }

    void OnLoaded(LoadedEventArgs e)
    {
        var updated = false;

        if (Mode != e.Mode)
        {
            Mode = e.Mode;
            updated = true;
        }

        if (OfficeColor != e.OfficeColor)
        {
            OfficeColor = e.OfficeColor;
            updated = true;
        }

        if (updated)
        {
            StateHasChanged();
        }
    }

    string GetCustomColor(OfficeColor? color)
    {
        var hex = color?.ToAttributeValue();
        return !string.IsNullOrWhiteSpace(hex) && !string.Equals(hex, "default", StringComparison.OrdinalIgnoreCase)
        ? hex
        : "#036ac4";
    }

    void OnLuminanceChanged(LuminanceChangedEventArgs e)
    {
        Console.WriteLine($@"Changed: {(e.Mode == DesignThemeModes.System ? "System" : "")} {(e.IsDark ? "Dark" : "Light")}");
    }

    void PickRandomColor()
    {
        OfficeColor = OfficeColorUtilities.GetRandom();
    }

    void ToggleThemeMenu()
    {
        IsThemeMenuOpen = !IsThemeMenuOpen;
    }

}
