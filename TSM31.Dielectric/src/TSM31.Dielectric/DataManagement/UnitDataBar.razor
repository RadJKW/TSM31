@inject ITestManager TestManager

<div id="unit-data-bar-container" class="flex flex-col w-full justify-center gap-2">
    <!-- Unit Data Bar (top summary) -->
    <div id="unit-data-bar" class="grid grid-cols-[1fr_1.5fr_1fr_0.5fr_0.8fr_1.5fr] gap-x-4 px-2 py-2 bg-neutral-layer-1 border border-neutral-stroke-rest">
        @{
            var unit = TestManager.CurrentUnit;
            var serial = unit?.SerialNumber ?? "0000000000";
            var catalog = unit?.CatalogNumber ?? "0000000000000";
            var unitType = unit?.UnitType ?? "-";
            var kva = (unit?.Kva ?? 000);
            var workOrder = unit?.WorkOrder ?? "00000";
            var customer = unit?.CustomerName ?? "Customer";
        }
        <FluentLabel Typo="Typography.H5" Class="mx-1 font-semibold whitespace-nowrap text-left flex items-center gap-1">
            Serial Number:
            <span class="flex-1 text-center px-2 py-0.5 bg-white/5 border border-white/20 rounded text-accent-fill-rest">@serial</span>
        </FluentLabel>
        <FluentLabel Typo="Typography.H5" Class="mx-1 font-semibold whitespace-nowrap text-left flex items-center gap-1">
            Catalog Number:
            <span class="flex-1 text-center px-2 py-0.5 bg-white/5 border border-white/20 rounded text-accent-fill-rest">@catalog</span>
        </FluentLabel>
        <FluentLabel Typo="Typography.H5" Class="mx-1 font-semibold whitespace-nowrap text-left flex items-center gap-1">
            Unit Type:
            <span class="flex-1 text-center px-2 py-0.5 bg-white/5 border border-white/20 rounded text-accent-fill-rest">@unitType</span>
        </FluentLabel>
        <FluentLabel Typo="Typography.H5" Class="mx-1 font-semibold whitespace-nowrap text-left flex items-center gap-1">
            KVA:
            <span class="flex-1 text-center px-2 py-0.5 bg-white/5 border border-white/20 rounded text-accent-fill-rest">@kva</span>
        </FluentLabel>
        <FluentLabel Typo="Typography.H5" Class="mx-1 font-semibold whitespace-nowrap text-left flex items-center gap-1">
            Work Order:
            <span class="flex-1 text-center px-2 py-0.5 bg-white/5 border border-white/20 rounded text-accent-fill-rest">@workOrder</span>
        </FluentLabel>
        <FluentLabel Typo="Typography.H5" Class="mx-1 font-semibold whitespace-nowrap text-left flex items-center gap-1">
            Customer:
            <span class="flex-1 text-center px-2 py-0.5 bg-white/5 border border-white/20 rounded text-accent-fill-rest">@customer</span>
        </FluentLabel>
    </div>

    <!-- Unit Configuration Table -->
    <div class="flex flex-col bg-neutral-layer-1 border border-neutral-stroke-rest rounded overflow-hidden">
        <div class="px-2 py-1">
            <FluentLabel Typo="Typography.H5" Class="font-semibold w-full">
                Unit Data
            </FluentLabel>
        </div>
        <DataTable TItem="UnitRatingRow" Items="@GetUnitRatingRows()" Columns="@_unitDataColumns"/>
    </div>
</div>

@code {

    // Helper class to represent a single row of unit rating data
    private class UnitRatingRow
    {
        public float PrimaryVolts { get; init; }
        public int PrimaryRatings { get; init; }
        public int PrimaryBushings { get; init; }
        public int PrimaryBIL { get; init; }
        public float SecondaryVolts { get; init; }
        public int SecondaryRatings { get; init; }
        public int SecondaryBushings { get; init; }
        public int SecondaryBIL { get; init; }
        public bool HasArrestor { get; init; }
    }

    private readonly List<TableColumnDefinition<UnitRatingRow>> _unitDataColumns =
    [
        new() { Header = "Primary Volts", ValueSelector = x => x.PrimaryVolts },
        new() { Header = "Ratings", ValueSelector = x => x.PrimaryRatings },
        new() { Header = "Bushings", ValueSelector = x => x.PrimaryBushings },
        new() { Header = "BIL", ValueSelector = x => x.PrimaryBIL, Format = "000" },
        new() { Header = "Secondary Volts", ValueSelector = x => x.SecondaryVolts },
        new() { Header = "Ratings", ValueSelector = x => x.SecondaryRatings },
        new() { Header = "Bushings", ValueSelector = x => x.SecondaryBushings },
        new() { Header = "BIL", ValueSelector = x => x.SecondaryBIL, Format = "000" },
        new()
        {
            Header = "Arrestor",
            ValueSelector = x => x.HasArrestor,
            CustomRender = item =>
                @<FluentBadge Appearance="@(item.HasArrestor ? Appearance.Accent : Appearance.Neutral)"
                              Class="text-[10px]! px-2! py-0.5!">
                    @(item.HasArrestor ? "Yes" : "No")
                </FluentBadge>
        }
    ];

    protected override void OnInitialized()
    {
        TestManager.OnUnitDataChanged += StateHasChanged;
    }

    public void Dispose()
    {
        TestManager.OnUnitDataChanged -= StateHasChanged;
    }

    private List<UnitRatingRow> GetUnitRatingRows()
    {
        var unit = TestManager.CurrentUnit;
        var index = unit?.CurrentTest > 0 ? unit.CurrentTest - 1 : 0;
        var ratings = unit != null && unit.Ratings.Count > index ? unit.Ratings[index] : null;

        return
        [
            new UnitRatingRow
            {
                PrimaryVolts = ratings?.PrimaryVoltage ?? 0,
                PrimaryRatings = unit?.PrimaryRatings ?? 0,
                PrimaryBushings = unit?.PrimaryBushings ?? 0,
                PrimaryBIL = ratings?.PrimaryBIL ?? 0,
                SecondaryVolts = ratings?.SecondaryVoltage ?? 0,
                SecondaryRatings = unit?.SecondaryRatings ?? 0,
                SecondaryBushings = unit?.SecondaryBushings ?? 0,
                SecondaryBIL = ratings?.SecondaryBIL ?? 0,
                HasArrestor = unit?.HasArrestor ?? false
            }
        ];
    }

}
